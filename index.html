<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSP Alignment Helper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>XSP Alignment Helper</h1>
            <div class="view-switcher">
                <a href="index.html" class="view-link active">Bidder View</a>
                <a href="publisher.html" class="view-link">Publisher View</a>
                <a href="endpoint.html" class="view-link">Endpoint View</a>
                <a href="opportunities.html" class="view-link">Opportunities</a>
            </div>
            <div class="last-updated" id="lastUpdated"></div>
        </div>

        <div class="file-inputs">
            <div>
                <label for="dataFile">Upload Data CSV:</label>
                <input type="file" id="dataFile" accept=".csv" class="file-input">
            </div>
            <div class="sellers-json-section">
                <button id="fetchSellersJson" class="fetch-button">Fetch Sellers.json</button>
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div id="progressBar" class="progress-bar"></div>
                    <div id="progressText" class="progress-text">Loading...</div>
                </div>
            </div>
        </div>

        <select id="bidderSelect" onchange="updateDisplay()">
            <option value="">Select a Bidder</option>
        </select>

        <input type="text" id="searchBox" class="search-box" placeholder="Search publishers..." onkeyup="filterPublishers()">

        <div id="publisherList"></div>
    </div>

    <a href="#" class="scroll-top" id="scrollTop">â†‘</a>

    <script>
        let globalData = [];
        let sellersData = {};
        let lastUpdateDate = '';
        const bidderRequirements = {
            // Your bidder requirements here
        };

        // File input handlers
        document.getElementById('dataFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                globalData = parseCSV(text);
                console.log('First parsed entry:', globalData[0]); // Debug log
                
                lastUpdateDate = globalData
                    .map(entry => entry.date_only)
                    .filter(date => date && date.trim())
                    .sort()
                    .pop();
                
                localStorage.setItem('dashboardData', JSON.stringify(globalData));
                localStorage.setItem('lastUpdateDate', lastUpdateDate);
                
                document.getElementById('lastUpdated').textContent = 
                    `Last Updated: ${formatDate(lastUpdateDate)}`;
                
                updateDropdown();
            };
            
            reader.readAsText(file);
        });

        // Replace the entire fetchSellersJson function with this new implementation
        async function fetchSellersJson() {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const fetchButton = document.getElementById('fetchSellersJson');

            console.log('fetchSellersJson function called');
            
            // Reset UI
            progressContainer.style.display = 'block';
            fetchButton.disabled = true;
            progressBar.style.width = '0%';
            progressText.textContent = 'Starting...';
            progressBar.style.backgroundColor = '#4CAF50';

            try {
                // Step 1: Try to fetch from multiple sources
                progressBar.style.width = '10%';
                progressText.textContent = 'Attempting to download sellers.json...';
                
                // Define our proxy URLs
                const proxyUrls = [
                    'https://api.allorigins.win/raw?url=https://lijit.com/sellers.json',
                    'https://corsproxy.io/?https://lijit.com/sellers.json',
                    'https://cors-anywhere.herokuapp.com/https://lijit.com/sellers.json'
                ];
                
                let jsonData = null;
                let fetchError = null;
                
                // Try each proxy in sequence
                for (let i = 0; i < proxyUrls.length; i++) {
                    const proxyUrl = proxyUrls[i];
                    progressBar.style.width = `${10 + (i * 10)}%`;
                    progressText.textContent = `Trying proxy ${i+1}...`;
                    
                    try {
                        console.log(`Trying proxy: ${proxyUrl}`);
                        const response = await fetch(proxyUrl);
                        
                        if (response.ok) {
                            const text = await response.text();
                            console.log(`Received ${text.length} bytes from proxy ${i+1}`);
                            
                            // Try to parse as JSON
                            try {
                                jsonData = JSON.parse(text);
                                console.log('Successfully parsed JSON data');
                                break; // Exit the loop if successful
                            } catch (parseError) {
                                console.error('Failed to parse JSON:', parseError);
                                console.log('First 100 chars:', text.substring(0, 100));
                            }
                        } else {
                            console.log(`Proxy ${i+1} returned status: ${response.status}`);
                        }
                    } catch (error) {
                        console.error(`Error with proxy ${i+1}:`, error);
                        fetchError = error;
                    }
                }
                
                // If all proxies failed, try to use cached data
                if (!jsonData) {
                    progressBar.style.width = '40%';
                    progressText.textContent = 'Download failed, checking cache...';
                    
                    const cachedData = localStorage.getItem('sellersData');
                    if (cachedData) {
                        try {
                            jsonData = JSON.parse(cachedData);
                            progressBar.style.width = '50%';
                            progressText.textContent = 'Using cached data';
                            console.log('Using cached sellers.json data');
                        } catch (e) {
                            console.error('Error parsing cached data:', e);
                        }
                    }
                    
                    // If we still don't have data, throw an error
                    if (!jsonData) {
                        throw new Error('Failed to download sellers.json and no cache available');
                    }
                }
                
                // Step 2: Process the data
                progressBar.style.width = '60%';
                progressText.textContent = 'Processing sellers data...';
                
                if (!jsonData.sellers || !Array.isArray(jsonData.sellers)) {
                    throw new Error('Invalid sellers.json format');
                }
                
                console.log(`Processing ${jsonData.sellers.length} sellers`);
                
                // Create a lookup object for faster access
                sellersData = {};
                jsonData.sellers.forEach(seller => {
                    if (seller && seller.seller_id) {
                        sellersData[seller.seller_id] = seller;
                    }
                });
                
                // Step 3: Save to localStorage
                progressBar.style.width = '80%';
                progressText.textContent = 'Saving to local storage...';
                
                try {
                    localStorage.setItem('sellersData', JSON.stringify(sellersData));
                    localStorage.setItem('sellersJsonLastFetch', new Date().toISOString());
                    console.log('Saved sellers data to localStorage');
                } catch (e) {
                    console.warn('Failed to save to localStorage:', e);
                    // Continue anyway since we have the data in memory
                }
                
                // Step 4: Complete
                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';
                console.log(`Successfully loaded ${Object.keys(sellersData).length} sellers`);
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    fetchButton.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('Error in fetchSellersJson:', error);
                progressText.textContent = `Error: ${error.message}`;
                progressBar.style.backgroundColor = '#ff4444';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    fetchButton.disabled = false;
                }, 1500);
            }
        }

        // Add click handler for the fetch button
        const setupButtonListener = function() {
            const fetchButton = document.getElementById('fetchSellersJson');
            if (fetchButton) {
                console.log('Setting up fetch button listener');
                // Remove any existing listeners to avoid duplicates
                fetchButton.removeEventListener('click', fetchSellersJson);
                // Add the new listener
                fetchButton.addEventListener('click', function() {
                    console.log('Fetch button clicked');
                    fetchSellersJson();
                });
                // Also set the onclick property as a fallback
                fetchButton.onclick = function() {
                    console.log('Fetch button onclick triggered');
                    fetchSellersJson();
                    return false; // Prevent default action
                };
            } else {
                console.error('Fetch button not found');
            }
        };

        // Call this function immediately
        setupButtonListener();

        // Also call it when the window loads
        window.addEventListener('load', function() {
            // Existing load event code...
            
            // Add this at the end of the load event handler
            setupButtonListener();
        });

        // Improved CSV parsing function
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                let row = lines[i];
                const values = [];
                let insideQuotes = false;
                let currentField = '';
                
                for (let j = 0; j < row.length; j++) {
                    const char = row[j];
                    
                    if (char === '"') {
                        if (!insideQuotes) {
                            insideQuotes = true;
                        } else if (row[j + 1] === '"') {
                            currentField += '"';
                            j++;
                        } else {
                            insideQuotes = false;
                        }
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField.trim());

                const entry = {};
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    if (header === 'pub_name') {
                        value = value
                            .replace(/^"/, '')
                            .replace(/"$/, '')
                            .replace(/, Inc\.$/, '')
                            .replace(/, Inc$/, '')
                            .replace(/, LLC\.?$/, '')
                            .replace(/, Ltd\.?$/, '')
                            .trim();
                    }
                    entry[header] = value;
                });
                
                data.push(entry);
            }
            
            return data;
        }

        // Helper functions
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function findSellerInfo(pub_id) {
            return sellersData[pub_id] || null;
        }

        // Load saved data when page loads
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('dashboardData');
            const savedSellers = localStorage.getItem('sellersData');
            const savedDate = localStorage.getItem('lastUpdateDate');
            
            if (savedData && savedSellers) {
                globalData = JSON.parse(savedData);
                sellersData = JSON.parse(savedSellers);
                lastUpdateDate = savedDate;
                
                document.getElementById('lastUpdated').textContent = 
                    `Last Updated: ${formatDate(lastUpdateDate)}`;
                updateDropdown();
            }

            console.log('Fetch button exists:', !!document.getElementById('fetchSellersJson'));
        });

        function updateDropdown() {
            const bidders = [...new Set(globalData
                .filter(entry => entry.bidder_name)
                .map(entry => entry.bidder_name))];
            
            const bidderSelect = document.getElementById('bidderSelect');
            bidderSelect.innerHTML = '<option value="">Select a Bidder</option>';
            bidders.sort().forEach(bidder => {
                if (bidder) {
                    bidderSelect.innerHTML += `<option value="${bidder}">${bidder}</option>`